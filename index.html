<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odoo Partner Qualification 360Â° â€” Formulario</title>
  <!-- Tailwind (estilos) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2pdf (PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @media print { .no-print { display:none !important; } }
    tr.red-flag { background-color:#fee2e2; color:#991b1b; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <!-- Encabezado -->
  <header class="bg-[#714B67] text-white p-4 shadow">
    <div class="max-w-7xl mx-auto flex items-center gap-3">
      <h1 class="text-xl font-semibold">Odoo Partner Qualification 360Â° â€” EvaluaciÃ³n PR/PM</h1>
      <div class="ml-auto hidden md:flex items-center gap-2 text-sm">
        <span>Tipo:</span><span id="badgeType" class="px-2 py-0.5 rounded bg-white/20">â€”</span>
        <span>Total:</span><span id="badgeScore" class="px-2 py-0.5 rounded bg-white/20">â€”</span>
        <span>RF:</span><span id="badgeRF" class="px-2 py-0.5 rounded bg-white/20">0</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Info bÃ¡sica -->
    <section class="bg-white p-4 rounded-2xl shadow">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="text-sm font-medium">Partner Name</label>
          <input id="partnerName" class="w-full border rounded px-2 py-1 mt-1" placeholder="Ej. ERP MÃ©xico" />
        </div>
        <div>
          <label class="text-sm font-medium">Partner Manager</label>
          <input id="partnerManager" class="w-full border rounded px-2 py-1 mt-1" placeholder="Ej. Alnu / Wanessa / AndrÃ©s" />
        </div>
        <div>
          <label class="text-sm font-medium">Modo por rol (quÃ© preguntas ver)</label>
          <select id="roleMode" class="w-full border rounded px-2 py-1 mt-1">
            <option value="all">Ver todo</option>
            <option value="Recruiter">Solo Recruiter + Compartidas</option>
            <option value="PM">Solo PM + Compartidas</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">BÃºsqueda rÃ¡pida</label>
          <input id="searchBox" class="w-full border rounded px-2 py-1 mt-1" placeholder="Filtra por texto en la pregunta..." />
        </div>
      </div>
      <p class="mt-2 text-xs text-gray-500">
        El total se calcula con <em>pesos internos Ã— Score 1â€“5</em>. Los evaluadores no ven los pesos.
      </p>
    </section>

    <!-- Contenido dinÃ¡mico -->
    <section id="formRoot" class="mt-6 space-y-6"></section>

    <!-- Footer de control -->
    <footer class="fixed bottom-4 left-0 right-0 px-4 no-print">
      <div class="max-w-7xl mx-auto bg-white border rounded-2xl shadow p-3 flex flex-col md:flex-row justify-between items-center gap-2">
        <div class="text-sm text-gray-600">
          <strong>Total:</strong> <span id="footerScore">â€”</span> Â· 
          <strong>Tipo:</strong> <span id="footerType">â€”</span> Â· 
          <strong>Red Flags:</strong> <span id="footerRF">0</span>
        </div>
        <div class="flex gap-2">
          <button id="btnClear" class="px-3 py-1 border rounded">Limpiar</button>
          <button id="btnXLSX" class="px-3 py-1 border rounded">Descargar Excel</button>
          <button id="btnPDF" class="px-3 py-1 bg-[#714B67] text-white rounded">Descargar PDF</button>
        </div>
      </div>
    </footer>
  </main>

  <!-- SecciÃ³n oculta para PDF -->
  <section id="pdfArea" class="hidden p-6">
    <h2 class="text-lg font-semibold">Odoo Partner Qualification 360Â° â€” Resultado</h2>
    <p class="text-sm text-gray-600">Generado: <span id="pdfDate"></span></p>
    <div class="grid grid-cols-2 gap-2 text-sm">
      <div><strong>Partner:</strong> <span id="pdfPartner"></span></div>
      <div><strong>Partner Manager:</strong> <span id="pdfPM"></span></div>
      <div><strong>Total:</strong> <span id="pdfScore"></span></div>
      <div><strong>ClasificaciÃ³n:</strong> <span id="pdfType"></span></div>
      <div><strong>Red Flags:</strong> <span id="pdfRF"></span></div>
    </div>
    <div class="mt-3">
      <table class="w-full text-xs border">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-1 text-left">Bloque</th>
            <th class="p-1 text-left">Rol</th>
            <th class="p-1 text-left">Pregunta</th>
            <th class="p-1 text-left">GuÃ­a</th>
            <th class="p-1 text-left">Peso</th>
            <th class="p-1 text-left">Score</th>
            <th class="p-1 text-left">ðŸš©</th>
            <th class="p-1 text-left">Comentarios</th>
          </tr>
        </thead>
        <tbody id="pdfBody"></tbody>
      </table>
    </div>
  </section>

  <script>
    // ================== Banco de Preguntas ==================
    // Rol puede ser "Recruiter", "PM" o "Ambos" (compartidas)
    const QUESTIONS = [
      // 0. PR â€“ Quick Profiling (Recruiter)
      ['PR â€“ Quick Profiling','Recruiter','Â¿Por quÃ© quieren ser Partner de Odoo?','1=Curiosidad Â· 3=Diversificar Â· 5=Plan estratÃ©gico',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Tienen equipo dedicado o solo el fundador?','1=Solo founder Â· 3=1â€“2 part-time Â· 5=2+ full-time',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Han considerado invertir en PLO / Success Pack / CertificaciÃ³n?','1=No Â· 3=En anÃ¡lisis Â· 5=Ya invirtieron',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Experiencia previa en ERPs o software?','1=Ninguna Â· 3=Otros ERPs Â· 5=Odoo',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿DÃ³nde ven a Odoo en 1â€“2 aÃ±os?','1=Incierto Â· 3=Complemento Â· 5=Core del negocio',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿QuiÃ©n toma la decisiÃ³n final?','1=Indefinido Â· 3=Founder Â· 5=ComitÃ©/direcciÃ³n',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Tienen presupuesto inicial (mkt/ventas/formaciÃ³n)?','1=0 Â· 3=$1â€“3k Â· 5=>$5k planificado',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿CuÃ¡ndo esperan cerrar su primera venta Enterprise?','1=>12m Â· 3=6â€“12m Â· 5=<3m',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Abiertos a reuniÃ³n con PM (30â€“60â€“90)?','1=No Â· 3=Tal vez Â· 5=SÃ­',2.5],
      ['PR â€“ Quick Profiling','Recruiter','Â¿Son end-customer o planean vender Community?','1=Community/end-customer Â· 3=Ambos Â· 5=Solo Enterprise',2.5],

      // 1. Estructura & Equipo (compartidas)
      ['Estructura & Equipo','Ambos','Â¿CuÃ¡ntas personas 100% dedicadas a Odoo?','1=1â€“2 Â· 3=3â€“4 Â· 5=5+',5],
      ['Estructura & Equipo','Ambos','Â¿Founder full-time en Odoo?','1=No Â· 3=Parcial Â· 5=SÃ­',5],

      // 2. Comerciales (PM)
      ['Comerciales','PM','Â¿Pipeline activo Enterprise?','1=Ninguno Â· 3=1â€“3 Â· 5=5+',3.75],
      ['Comerciales','PM','Â¿Win rate Ãºltimos 12m?','1=<10% Â· 3=30% Â· 5=>50%',3.75],
      ['Comerciales','PM','Â¿Tienen equipo de ventas formal?','1=No Â· 3=1 parcial Â· 5=Equipo dedicado',3.75],
      ['Comerciales','PM','Â¿ICP o vertical definido?','1=No Â· 3=Parcial Â· 5=Claro',3.75],

      // 3. TÃ©cnicas (PM)
      ['TÃ©cnicas','PM','Â¿Consultores certificados (Ãºltimas 3 versiones)?','1=0 Â· 3=1â€“2 Â· 5=3+',3.33],
      ['TÃ©cnicas','PM','Â¿Cobertura de mÃ³dulos clave?','1=1 mÃ³dulo Â· 3=3 mÃ³dulos Â· 5=4+',3.33],
      ['TÃ©cnicas','PM','Â¿Usan Odoo.sh y QA/DevOps?','1=No Â· 3=Parcial Â· 5=SÃ­',3.33],

      // 4. Delivery & CS (PM)
      ['Delivery & CS','PM','Â¿MetodologÃ­a de implementaciÃ³n?','1=Ad-hoc Â· 3=Semi Â· 5=Formalizada/Ã¡gil',2.5],
      ['Delivery & CS','PM','Â¿Time-to-first-value promedio?','1=>6m Â· 3=3â€“6m Â· 5=<3m',2.5],
      ['Delivery & CS','PM','Â¿Miden NPS/CSAT o casos de Ã©xito?','1=No Â· 3=1â€“2 Â· 5=SÃ­',2.5],
      ['Delivery & CS','PM','Â¿Post-go-live (soporte/upsell)?','1=Reactivo Â· 3=BÃ¡sico Â· 5=Proactivo/SLA',2.5],

      // 5. Compromiso con Odoo (PM)
      ['Compromiso','PM','Â¿Participan en trainings/webinars/eventos?','1=Nunca Â· 3=Ocasional Â· 5=Frecuente',1.66],
      ['Compromiso','PM','Â¿Han hecho co-sell o co-marketing?','1=No Â· 3=Piloto Â· 5=SÃ­',1.66],
      ['Compromiso','PM','Â¿QuÃ© esperan de Odoo?','1=Leads gratis Â· 3=Soporte Â· 5=Alianza estratÃ©gica',1.66],

      // 6. Clientes & RetenciÃ³n (PM)
      ['Clientes & RetenciÃ³n','PM','Â¿Clientes activos Enterprise?','1=0 Â· 3=1â€“3 Â· 5=5+',1.66],
      ['Clientes & RetenciÃ³n','PM','Â¿Retention rate anual?','1=<70% Â· 3=80% Â· 5=>90%',1.66],
      ['Clientes & RetenciÃ³n','PM','Â¿Migraciones de Community a Enterprise?','1=Ninguna Â· 3=1â€“2 Â· 5=Recurrentes',1.66],

      // 7. Riesgos & Alertas (compartidas)
      ['Riesgos & Alertas','Ambos','Â¿Dependen de 1â€“2 clientes?','1=SÃ­ (80%+) Â· 3=Parcial Â· 5=Diversificado',1.66],
      ['Riesgos & Alertas','Ambos','Â¿RotaciÃ³n alta de talento (>15%)?','1=Alta Â· 3=Media Â· 5=Baja',1.66],
      ['Riesgos & Alertas','Ambos','Â¿Community-only o end-customer?','1=SÃ­ Â· 3=Parcial Â· 5=No',1.66]
    ];

    // =============== Render dinÃ¡mico ===============
    const formRoot = document.getElementById('formRoot');
    const grouped = QUESTIONS.reduce((a,[b,...r])=>((a[b]??=[]).push(r),a),{});
    let qIndex=0;
    Object.entries(grouped).forEach(([block,list])=>{
      const card=document.createElement('div');
      card.className='bg-white rounded-2xl shadow overflow-hidden';
      card.innerHTML=`
        <div class="bg-gray-100 p-2 font-semibold">${block}</div>
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-50 text-gray-600">
              <th class="p-1 text-left">Rol</th>
              <th class="p-1 text-left">Pregunta</th>
              <th class="p-1 text-left">GuÃ­a</th>
              <th class="p-1 text-left">Score</th>
              <th class="p-1 text-left">ðŸš©</th>
              <th class="p-1 text-left">Comentarios</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>`;
      const tb=card.querySelector('tbody');
      list.forEach(([role,q,guide,weight])=>{
        qIndex++;
        const tr=document.createElement('tr');
        tr.dataset.role=role; tr.dataset.weight=weight; tr.dataset.block=block;
        tr.innerHTML=`
          <td class="p-1">${role}</td>
          <td class="p-1 question-text">${q}</td>
          <td class="p-1 text-xs text-gray-500">${guide}</td>
          <td class="p-1">
            <select id="s${qIndex}" class="border rounded px-1 py-0.5 text-sm">
              <option value="">â€”</option>${[1,2,3,4,5].map(n=>`<option>${n}</option>`).join('')}
            </select>
          </td>
          <td class="p-1 text-center"><input id="rf${qIndex}" type="checkbox"></td>
          <td class="p-1"><textarea id="d${qIndex}" rows="1" class="w-full border rounded text-xs px-1" placeholder="Detalles..."></textarea></td>`;
        tb.appendChild(tr);
      });
      formRoot.appendChild(card);
    });

    // =============== Filtros: Modo por rol + bÃºsqueda ===============
    const roleMode=document.getElementById('roleMode');
    const searchBox=document.getElementById('searchBox');

    function applyFilters(){
      const mode = roleMode.value; // 'all' | 'Recruiter' | 'PM'
      const q = (searchBox.value || '').toLowerCase();
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        const role = tr.dataset.role;
        const text = tr.querySelector('.question-text').innerText.toLowerCase();
        const roleOk = (mode==='all') ||
                       (mode==='Recruiter' && (role==='Recruiter' || role==='Ambos')) ||
                       (mode==='PM' && (role==='PM' || role==='Ambos'));
        const textOk = q==='' || text.includes(q);
        tr.classList.toggle('hidden', !(roleOk && textOk));
      });
    }
    roleMode.addEventListener('change', applyFilters);
    searchBox.addEventListener('input', applyFilters);

    // =============== Scoring y clasificaciÃ³n ===============
    function classify(total){
      if(total>=4.3) return ['Strategic','bg-green-100 text-green-800'];
      if(total>=3.6) return ['Growth','bg-blue-100 text-blue-800'];
      if(total>=2.9) return ['Active','bg-yellow-100 text-yellow-900'];
      return ['Low Fit','bg-red-100 text-red-800'];
    }

    function recalcTotals(){
      let total=0, rf=0, answered=false;
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return; // ignora las ocultas por filtro visual
        const val=parseFloat(tr.querySelector('select').value||'');
        const red=(val && val<=2) || tr.querySelector('input[type="checkbox"]').checked;
        tr.classList.toggle('red-flag', red);
        if(!isNaN(val)){ total += (val * (parseFloat(tr.dataset.weight)/100)); answered=true; }
        if(red) rf++;
      });
      const [label, cls] = classify(total);
      // badges header
      const badgeType = document.getElementById('badgeType');
      badgeType.className = 'px-2 py-0.5 rounded ' + (answered?cls:'bg-white/20');
      badgeType.textContent = answered?label:'â€”';
      document.getElementById('badgeScore').textContent = answered?total.toFixed(2):'â€”';
      document.getElementById('badgeRF').textContent = rf.toString();
      // footer
      document.getElementById('footerScore').textContent = answered?total.toFixed(2):'â€”';
      document.getElementById('footerType').textContent = answered?label:'â€”';
      document.getElementById('footerRF').textContent = rf.toString();
    }
    document.addEventListener('change',e=>{
      if(e.target.matches('select,input[type="checkbox"]')) recalcTotals();
    });

    // =============== Limpiar ===============
    document.getElementById('btnClear').onclick=()=>{
      document.querySelectorAll('select').forEach(s=>s.value='');
      document.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
      document.querySelectorAll('textarea').forEach(t=>t.value='');
      document.querySelectorAll('tr').forEach(tr=>tr.classList.remove('red-flag','hidden'));
      roleMode.value='all'; searchBox.value='';
      recalcTotals();
    };

    // =============== PDF ===============
    document.getElementById('btnPDF').onclick=()=>{
      const partner = (document.getElementById('partnerName').value||'Partner').trim();
      document.getElementById('pdfDate').textContent=new Date().toLocaleString();
      document.getElementById('pdfPartner').textContent=partner;
      document.getElementById('pdfPM').textContent=document.getElementById('partnerManager').value;
      document.getElementById('pdfScore').textContent=document.getElementById('footerScore').textContent;
      document.getElementById('pdfType').textContent=document.getElementById('footerType').textContent;
      document.getElementById('pdfRF').textContent=document.getElementById('footerRF').textContent;

      const tb=document.getElementById('pdfBody'); tb.innerHTML='';
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return; // respeta filtro actual
        const sel=tr.querySelector('select'), val=sel.value||'';
        const rf=tr.querySelector('input[type="checkbox"]').checked?'SÃ­':'';
        const guide=tr.children[2].textContent.trim();
        const weight=tr.dataset.weight;
        const d=tr.querySelector('textarea').value||'';
        if(val!=='' || rf || d){
          const row=document.createElement('tr');
          row.innerHTML=`
            <td class="p-1 border">${tr.dataset.block}</td>
            <td class="p-1 border">${tr.dataset.role}</td>
            <td class="p-1 border">${tr.children[1].textContent}</td>
            <td class="p-1 border">${guide}</td>
            <td class="p-1 border">${weight}</td>
            <td class="p-1 border">${val}</td>
            <td class="p-1 border">${rf}</td>
            <td class="p-1 border">${d}</td>`;
          if((val && parseFloat(val)<=2) || rf) row.classList.add('red-flag');
          tb.appendChild(row);
        }
      });
      const opt={margin:10,filename:`Qualification_${partner.replace(/\s+/g,'_')}.pdf`,html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}};
      const src=document.getElementById('pdfArea');
      src.classList.remove('hidden');
      html2pdf().set(opt).from(src).save().then(()=>src.classList.add('hidden'));
    };

    // =============== Excel (.xlsx) ===============
    document.getElementById('btnXLSX').onclick=()=>{
      const partner = (document.getElementById('partnerName').value||'Partner').trim();
      // Sheet 1: Resumen
      const resumen = [
        ['Partner', partner],
        ['Partner Manager', document.getElementById('partnerManager').value],
        ['Total', document.getElementById('footerScore').textContent],
        ['ClasificaciÃ³n', document.getElementById('footerType').textContent],
        ['Red Flags (#)', document.getElementById('footerRF').textContent],
        ['Generado', new Date().toLocaleString()],
        ['Modo por rol', document.getElementById('roleMode').value],
        ['Filtro texto', document.getElementById('searchBox').value]
      ];
      const wsResumen = XLSX.utils.aoa_to_sheet(resumen);

      // Sheet 2: Respuestas detalladas
      const head = ['Bloque','Rol','Pregunta','GuÃ­a','Peso','Score','Red Flag','Comentarios'];
      const rows = [head];
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return; // respeta filtro visual
        const val = tr.querySelector('select').value || '';
        const rf  = tr.querySelector('input[type="checkbox"]').checked ? 'SÃ­' : '';
        const guia= tr.children[2].textContent.trim();
        const peso= tr.dataset.weight;
        const det = tr.querySelector('textarea').value || '';
        if(val!=='' || rf || det){
          rows.push([
            tr.dataset.block,
            tr.dataset.role,
            tr.children[1].textContent,
            guia,
            peso,
            val,
            rf,
            det
          ]);
        }
      });
      const wsDet = XLSX.utils.aoa_to_sheet(rows);

      // Workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
      XLSX.utils.book_append_sheet(wb, wsDet, 'Respuestas');
      XLSX.writeFile(wb, `Qualification_${partner.replace(/\s+/g,'_')}.xlsx`);
    };

    // Inicial
    applyFilters();
    recalcTotals();
  </script>
</body>
</html>
