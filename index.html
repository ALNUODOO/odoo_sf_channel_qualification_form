<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Odoo Partner Qualification 360° — Formulario</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    @media print { .no-print { display:none !important; } }
    tr.red-flag { background-color:#fee2e2; color:#991b1b; }
    body { padding-bottom: 100px; }
    .badge { transition: all 0.3s ease; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <header class="bg-[#714B67] text-white p-4 shadow sticky top-0 z-10">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center gap-3 flex-wrap">
        <h1 class="text-lg md:text-xl font-semibold">Odoo Partner Qualification 360° — Evaluación PR/PM</h1>
        <div class="ml-auto flex items-center gap-2 text-xs md:text-sm flex-wrap">
          <div class="flex items-center gap-1">
            <span>Tipo:</span><span id="badgeType" class="badge px-2 py-0.5 rounded bg-white/20">—</span>
          </div>
          <div class="flex items-center gap-1">
            <span>Total:</span><span id="badgeScore" class="badge px-2 py-0.5 rounded bg-white/20">—</span>
          </div>
          <div class="flex items-center gap-1">
            <span>RF:</span><span id="badgeRF" class="badge px-2 py-0.5 rounded bg-white/20">0</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="bg-white p-4 rounded-2xl shadow">
      <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="text-sm font-medium block">Partner Name *</label>
          <input id="partnerName" class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#714B67] focus:border-transparent" placeholder="Ej. ERP México" />
        </div>
        <div>
          <label class="text-sm font-medium block">Partner Manager *</label>
          <input id="partnerManager" class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#714B67] focus:border-transparent" placeholder="Ej. Alnu / Wanessa / Andrés" />
        </div>
        <div>
          <label class="text-sm font-medium block">Modo por rol</label>
          <select id="roleMode" class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#714B67] focus:border-transparent">
            <option value="all">Ver todo</option>
            <option value="Recruiter">Solo Recruiter + Compartidas</option>
            <option value="PM">Solo PM + Compartidas</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium block">Búsqueda rápida</label>
          <input id="searchBox" class="w-full border rounded px-3 py-2 mt-1 focus:ring-2 focus:ring-[#714B67] focus:border-transparent" placeholder="Filtra por texto..." />
        </div>
      </div>
      <p class="mt-3 text-xs text-gray-500 bg-blue-50 p-2 rounded">
        💡 <strong>Nota:</strong> El total se calcula con <em>pesos internos × Score 1–5</em>. Los evaluadores no ven los pesos.
      </p>
    </section>

    <section id="formRoot" class="mt-6 space-y-6"></section>

    <div class="h-20"></div>
  </main>

  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-20 no-print">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <div class="flex flex-col md:flex-row justify-between items-center gap-3">
        <div class="text-sm text-gray-700 font-medium">
          <span class="inline-block mr-3"><strong>Total:</strong> <span id="footerScore" class="text-[#714B67]">—</span></span>
          <span class="inline-block mr-3"><strong>Tipo:</strong> <span id="footerType">—</span></span>
          <span class="inline-block"><strong>Red Flags:</strong> <span id="footerRF" class="text-red-600">0</span></span>
        </div>
        <div class="flex gap-2 flex-wrap justify-center">
          <button id="btnClear" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50 transition text-sm font-medium">
            🗑️ Limpiar
          </button>
          <button id="btnXLSX" class="px-4 py-2 border border-green-300 bg-green-50 text-green-800 rounded hover:bg-green-100 transition text-sm font-medium">
            📊 Excel
          </button>
          <button id="btnPDF" class="px-4 py-2 bg-[#714B67] text-white rounded hover:bg-[#5a3a52] transition text-sm font-medium">
            📄 PDF
          </button>
        </div>
      </div>
    </div>
  </footer>

  <section id="pdfArea" class="hidden p-6">
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-[#714B67]">Odoo Partner Qualification 360°</h2>
      <p class="text-sm text-gray-600 mt-1">Generado: <span id="pdfDate"></span></p>
    </div>
    <div class="grid grid-cols-2 gap-3 text-sm mb-4 bg-gray-50 p-3 rounded">
      <div><strong>Partner:</strong> <span id="pdfPartner"></span></div>
      <div><strong>Partner Manager:</strong> <span id="pdfPM"></span></div>
      <div><strong>Total:</strong> <span id="pdfScore"></span></div>
      <div><strong>Clasificación:</strong> <span id="pdfType"></span></div>
      <div><strong>Red Flags:</strong> <span id="pdfRF"></span></div>
    </div>
    <div class="mt-4">
      <h3 class="font-semibold mb-2">Respuestas Detalladas</h3>
      <table class="w-full text-xs border-collapse">
        <thead class="bg-[#714B67] text-white">
          <tr>
            <th class="p-2 text-left border">Bloque</th>
            <th class="p-2 text-left border">Rol</th>
            <th class="p-2 text-left border">Pregunta</th>
            <th class="p-2 text-left border">Guía</th>
            <th class="p-2 text-left border">Peso</th>
            <th class="p-2 text-left border">Score</th>
            <th class="p-2 text-left border">🚩</th>
            <th class="p-2 text-left border">Comentarios</th>
          </tr>
        </thead>
        <tbody id="pdfBody"></tbody>
      </table>
    </div>
  </section>

  <script>
    const QUESTIONS = [
      ['PR – Quick Profiling','Recruiter','¿Por qué quieren ser Partner de Odoo?','1=Curiosidad · 3=Diversificar · 5=Plan estratégico',2.5],
      ['PR – Quick Profiling','Recruiter','¿Tienen equipo dedicado o solo el fundador?','1=Solo founder · 3=1–2 part-time · 5=2+ full-time',2.5],
      ['PR – Quick Profiling','Recruiter','¿Han considerado invertir en PLO / Success Pack / Certificación?','1=No · 3=En análisis · 5=Ya invirtieron',2.5],
      ['PR – Quick Profiling','Recruiter','¿Experiencia previa en ERPs o software?','1=Ninguna · 3=Otros ERPs · 5=Odoo',2.5],
      ['PR – Quick Profiling','Recruiter','¿Dónde ven a Odoo en 1–2 años?','1=Incierto · 3=Complemento · 5=Core del negocio',2.5],
      ['PR – Quick Profiling','Recruiter','¿Quién toma la decisión final?','1=Indefinido · 3=Founder · 5=Comité/dirección',2.5],
      ['PR – Quick Profiling','Recruiter','¿Tienen presupuesto inicial (mkt/ventas/formación)?','1=0 · 3=$1–3k · 5=>$5k planificado',2.5],
      ['PR – Quick Profiling','Recruiter','¿Cuándo esperan cerrar su primera venta Enterprise?','1=>12m · 3=6–12m · 5=<3m',2.5],
      ['PR – Quick Profiling','Recruiter','¿Abiertos a reunión con PM (30–60–90)?','1=No · 3=Tal vez · 5=Sí',2.5],
      ['PR – Quick Profiling','Recruiter','¿Son end-customer o planean vender Community?','1=Community/end-customer · 3=Ambos · 5=Solo Enterprise',2.5],
      ['Estructura & Equipo','Ambos','¿Cuántas personas 100% dedicadas a Odoo?','1=1–2 · 3=3–4 · 5=5+',5],
      ['Estructura & Equipo','Ambos','¿Founder full-time en Odoo?','1=No · 3=Parcial · 5=Sí',5],
      ['Comerciales','PM','¿Pipeline activo Enterprise?','1=Ninguno · 3=1–3 · 5=5+',3.75],
      ['Comerciales','PM','¿Win rate últimos 12m?','1=<10% · 3=30% · 5=>50%',3.75],
      ['Comerciales','PM','¿Tienen equipo de ventas formal?','1=No · 3=1 parcial · 5=Equipo dedicado',3.75],
      ['Comerciales','PM','¿ICP o vertical definido?','1=No · 3=Parcial · 5=Claro',3.75],
      ['Técnicas','PM','¿Consultores certificados (últimas 3 versiones)?','1=0 · 3=1–2 · 5=3+',3.33],
      ['Técnicas','PM','¿Cobertura de módulos clave?','1=1 módulo · 3=3 módulos · 5=4+',3.33],
      ['Técnicas','PM','¿Usan Odoo.sh y QA/DevOps?','1=No · 3=Parcial · 5=Sí',3.33],
      ['Delivery & CS','PM','¿Metodología de implementación?','1=Ad-hoc · 3=Semi · 5=Formalizada/ágil',2.5],
      ['Delivery & CS','PM','¿Time-to-first-value promedio?','1=>6m · 3=3–6m · 5=<3m',2.5],
      ['Delivery & CS','PM','¿Miden NPS/CSAT o casos de éxito?','1=No · 3=1–2 · 5=Sí',2.5],
      ['Delivery & CS','PM','¿Post-go-live (soporte/upsell)?','1=Reactivo · 3=Básico · 5=Proactivo/SLA',2.5],
      ['Compromiso','PM','¿Participan en trainings/webinars/eventos?','1=Nunca · 3=Ocasional · 5=Frecuente',1.66],
      ['Compromiso','PM','¿Han hecho co-sell o co-marketing?','1=No · 3=Piloto · 5=Sí',1.66],
      ['Compromiso','PM','¿Qué esperan de Odoo?','1=Leads gratis · 3=Soporte · 5=Alianza estratégica',1.66],
      ['Clientes & Retención','PM','¿Clientes activos Enterprise?','1=0 · 3=1–3 · 5=5+',1.66],
      ['Clientes & Retención','PM','¿Retention rate anual?','1=<70% · 3=80% · 5=>90%',1.66],
      ['Clientes & Retención','PM','¿Migraciones de Community a Enterprise?','1=Ninguna · 3=1–2 · 5=Recurrentes',1.66],
      ['Riesgos & Alertas','Ambos','¿Dependen de 1–2 clientes?','1=Sí (80%+) · 3=Parcial · 5=Diversificado',1.66],
      ['Riesgos & Alertas','Ambos','¿Rotación alta de talento (>15%)?','1=Alta · 3=Media · 5=Baja',1.66],
      ['Riesgos & Alertas','Ambos','¿Community-only o end-customer?','1=Sí · 3=Parcial · 5=No',1.66]
    ];

    const formRoot = document.getElementById('formRoot');
    const grouped = QUESTIONS.reduce((a,[b,...r])=>((a[b]??=[]).push(r),a),{});
    let qIndex=0;

    Object.entries(grouped).forEach(([block,list])=>{
      const card=document.createElement('div');
      card.className='bg-white rounded-2xl shadow overflow-hidden';
      card.innerHTML=`
        <div class="bg-gradient-to-r from-[#714B67] to-[#8a5d7f] text-white p-3 font-semibold text-lg">
          ${block}
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-gray-100 text-gray-700">
                <th class="p-2 text-left font-medium">Rol</th>
                <th class="p-2 text-left font-medium">Pregunta</th>
                <th class="p-2 text-left font-medium">Guía</th>
                <th class="p-2 text-left font-medium">Score</th>
                <th class="p-2 text-center font-medium">🚩</th>
                <th class="p-2 text-left font-medium">Comentarios</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>`;
      const tb=card.querySelector('tbody');
      list.forEach(([role,q,guide,weight])=>{
        qIndex++;
        const tr=document.createElement('tr');
        tr.dataset.role=role; tr.dataset.weight=weight; tr.dataset.block=block;
        tr.className='border-t hover:bg-gray-50 transition';
        tr.innerHTML=`
          <td class="p-2">
            <span class="inline-block px-2 py-1 text-xs rounded ${role==='Recruiter'?'bg-blue-100 text-blue-800':role==='PM'?'bg-purple-100 text-purple-800':'bg-green-100 text-green-800'}">
              ${role}
            </span>
          </td>
          <td class="p-2 question-text">${q}</td>
          <td class="p-2 text-xs text-gray-600">${guide}</td>
          <td class="p-2">
            <select id="s${qIndex}" class="border rounded px-2 py-1 text-sm w-20 focus:ring-2 focus:ring-[#714B67] focus:border-transparent">
              <option value="">—</option>
              ${[1,2,3,4,5].map(n=>`<option value="${n}">${n}</option>`).join('')}
            </select>
          </td>
          <td class="p-2 text-center">
            <input id="rf${qIndex}" type="checkbox" class="w-4 h-4 cursor-pointer">
          </td>
          <td class="p-2">
            <textarea id="d${qIndex}" rows="1" class="w-full border rounded text-xs px-2 py-1 focus:ring-2 focus:ring-[#714B67] focus:border-transparent" placeholder="Añade comentarios..."></textarea>
          </td>`;
        tb.appendChild(tr);
      });
      formRoot.appendChild(card);
    });

    const roleMode=document.getElementById('roleMode');
    const searchBox=document.getElementById('searchBox');

    function applyFilters(){
      const mode = roleMode.value;
      const q = (searchBox.value || '').toLowerCase();
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        const role = tr.dataset.role;
        const text = tr.querySelector('.question-text').innerText.toLowerCase();
        const roleOk = (mode==='all') ||
                       (mode==='Recruiter' && (role==='Recruiter' || role==='Ambos')) ||
                       (mode==='PM' && (role==='PM' || role==='Ambos'));
        const textOk = q==='' || text.includes(q);
        tr.classList.toggle('hidden', !(roleOk && textOk));
      });
      recalcTotals();
    }

    roleMode.addEventListener('change', applyFilters);
    searchBox.addEventListener('input', applyFilters);

    function classify(total){
      if(total>=4.3) return ['Strategic','bg-green-500 text-white'];
      if(total>=3.6) return ['Growth','bg-blue-500 text-white'];
      if(total>=2.9) return ['Active','bg-yellow-500 text-white'];
      return ['Low Fit','bg-red-500 text-white'];
    }

    function recalcTotals(){
      let total=0, rf=0, answered=false;
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return;
        const val=parseFloat(tr.querySelector('select').value||'');
        const red=(val && val<=2) || tr.querySelector('input[type="checkbox"]').checked;
        tr.classList.toggle('red-flag', red);
        if(!isNaN(val)){ total += (val * (parseFloat(tr.dataset.weight)/100)); answered=true; }
        if(red) rf++;
      });
      const [label, cls] = classify(total);
      
      const badgeType = document.getElementById('badgeType');
      badgeType.className = 'badge px-2 py-0.5 rounded ' + (answered?cls:'bg-white/20');
      badgeType.textContent = answered?label:'—';
      document.getElementById('badgeScore').textContent = answered?total.toFixed(2):'—';
      document.getElementById('badgeRF').textContent = rf.toString();
      
      document.getElementById('footerScore').textContent = answered?total.toFixed(2):'—';
      document.getElementById('footerType').textContent = answered?label:'—';
      document.getElementById('footerRF').textContent = rf.toString();
    }

    document.addEventListener('change',e=>{
      if(e.target.matches('select,input[type="checkbox"]')) recalcTotals();
    });

    document.getElementById('btnClear').onclick=()=>{
      if(!confirm('¿Seguro que deseas limpiar todo el formulario?')) return;
      document.querySelectorAll('select').forEach(s=>s.value='');
      document.querySelectorAll('input[type="checkbox"]').forEach(c=>c.checked=false);
      document.querySelectorAll('textarea').forEach(t=>t.value='');
      document.querySelectorAll('tr').forEach(tr=>tr.classList.remove('red-flag','hidden'));
      roleMode.value='all'; searchBox.value='';
      document.getElementById('partnerName').value='';
      document.getElementById('partnerManager').value='';
      recalcTotals();
    };

    document.getElementById('btnPDF').onclick=()=>{
      const partner = document.getElementById('partnerName').value.trim();
      const pm = document.getElementById('partnerManager').value.trim();
      
      if(!partner || !pm){
        alert('Por favor completa Partner Name y Partner Manager antes de generar el PDF.');
        return;
      }

      document.getElementById('pdfDate').textContent=new Date().toLocaleString('es-ES');
      document.getElementById('pdfPartner').textContent=partner;
      document.getElementById('pdfPM').textContent=pm;
      document.getElementById('pdfScore').textContent=document.getElementById('footerScore').textContent;
      document.getElementById('pdfType').textContent=document.getElementById('footerType').textContent;
      document.getElementById('pdfRF').textContent=document.getElementById('footerRF').textContent;

      const tb=document.getElementById('pdfBody'); tb.innerHTML='';
      let hasData = false;
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return;
        const sel=tr.querySelector('select'), val=sel.value||'';
        const rf=tr.querySelector('input[type="checkbox"]').checked?'Sí':'';
        const guide=tr.children[2].textContent.trim();
        const weight=tr.dataset.weight;
        const d=tr.querySelector('textarea').value||'';
        if(val!=='' || rf || d){
          hasData = true;
          const row=document.createElement('tr');
          row.innerHTML=`
            <td class="p-2 border">${tr.dataset.block}</td>
            <td class="p-2 border">${tr.dataset.role}</td>
            <td class="p-2 border">${tr.children[1].textContent}</td>
            <td class="p-2 border">${guide}</td>
            <td class="p-2 border">${weight}</td>
            <td class="p-2 border">${val}</td>
            <td class="p-2 border">${rf}</td>
            <td class="p-2 border">${d}</td>`;
          if((val && parseFloat(val)<=2) || rf) row.classList.add('red-flag');
          tb.appendChild(row);
        }
      });

      if(!hasData){
        alert('No hay respuestas para exportar. Por favor completa al menos una pregunta.');
        return;
      }

      const opt={
        margin: 10,
        filename: `Qualification_${partner.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`,
        html2canvas: {scale: 2},
        jsPDF: {unit:'mm', format:'a4', orientation:'portrait'}
      };
      const src=document.getElementById('pdfArea');
      src.classList.remove('hidden');
      html2pdf().set(opt).from(src).save().then(()=>src.classList.add('hidden'));
    };

    document.getElementById('btnXLSX').onclick=()=>{
      const partner = document.getElementById('partnerName').value.trim();
      const pm = document.getElementById('partnerManager').value.trim();
      
      if(!partner || !pm){
        alert('Por favor completa Partner Name y Partner Manager antes de generar el Excel.');
        return;
      }

      const resumen = [
        ['Partner', partner],
        ['Partner Manager', pm],
        ['Total', document.getElementById('footerScore').textContent],
        ['Clasificación', document.getElementById('footerType').textContent],
        ['Red Flags (#)', document.getElementById('footerRF').textContent],
        ['Generado', new Date().toLocaleString('es-ES')],
        ['Modo por rol', document.getElementById('roleMode').value],
        ['Filtro texto', document.getElementById('searchBox').value]
      ];
      const wsResumen = XLSX.utils.aoa_to_sheet(resumen);

      const head = ['Bloque','Rol','Pregunta','Guía','Peso','Score','Red Flag','Comentarios'];
      const rows = [head];
      let hasData = false;
      document.querySelectorAll('#formRoot tbody tr').forEach(tr=>{
        if(tr.classList.contains('hidden')) return;
        const val = tr.querySelector('select').value || '';
        const rf  = tr.querySelector('input[type="checkbox"]').checked ? 'Sí' : '';
        const guia= tr.children[2].textContent.trim();
        const peso= tr.dataset.weight;
        const det = tr.querySelector('textarea').value || '';
        if(val!=='' || rf || det){
          hasData = true;
          rows.push([
            tr.dataset.block,
            tr.dataset.role,
            tr.children[1].textContent,
            guia,
            peso,
            val,
            rf,
            det
          ]);
        }
      });

      if(!hasData){
        alert('No hay respuestas para exportar. Por favor completa al menos una pregunta.');
        return;
      }

      const wsDet = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');
      XLSX.utils.book_append_sheet(wb, wsDet, 'Respuestas');
      XLSX.writeFile(wb, `Qualification_${partner.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
    };

    applyFilters();
    recalcTotals();
  </script>
</body>
</html>
